<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Administrador de instalaciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #020617;
      --border: #1f2937;
      --primary: #22c55e;
      --primary-soft: #052e16;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617, #020617 40%, #0b1120 100%);
      color: var(--text);
      padding: 1.5rem;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.4rem;
    }

    p {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 1rem 1.2rem;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      margin-bottom: 1rem;
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.6rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .section-title {
      margin-top: 0.8rem;
      margin-bottom: 0.3rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .field-label {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.15rem;
    }

    .field {
      margin-bottom: 0.5rem;
    }

    .input, .select, .textarea {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      padding: 0.45rem 0.8rem;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .textarea {
      border-radius: 10px;
      min-height: 70px;
      resize: vertical;
      padding: 0.5rem 0.7rem;
      line-height: 1.4;
    }

    .input:focus, .select:focus, .textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-soft);
    }

    .row {
      display: flex;
      gap: 0.6rem;
    }

    .row > div {
      flex: 1;
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
    }

    .checkbox-group label {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      cursor: pointer;
    }

    .checkbox-group input {
      accent-color: var(--primary);
    }

    .btn-row {
      display: flex;
      gap: 0.6rem;
      margin-top: 0.8rem;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 0.45rem 1rem;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: #022c22;
      font-weight: 600;
    }

    .btn-secondary {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      font-size: 0.8rem;
      padding-inline: 0.7rem;
    }

    .btn-small {
      padding: 0.25rem 0.7rem;
      font-size: 0.78rem;
    }

    .status {
      margin-top: 0.7rem;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .status.error {
      color: var(--danger);
    }

    .tag-list {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .small {
      font-size: 0.78rem;
      color: var(--muted);
    }

    /* Layout admin con men√∫ lateral */
    .admin-layout {
      display: flex;
      gap: 1rem;
      margin-top: 0.3rem;
    }

    .sidebar {
      width: 180px;
      border-right: 1px solid var(--border);
      padding-right: 0.8rem;
      padding-top: 0.2rem;
    }

    .admin-main {
      flex: 1;
      min-width: 0;
    }

    .nav-btn {
      width: 100%;
      text-align: left;
      margin-bottom: 0.35rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--muted);
      font-size: 0.8rem;
      padding: 0.3rem 0.7rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .nav-btn.active {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: var(--primary);
    }

    .lista-admin {
      border-radius: 10px;
      border: 1px solid var(--border);
      max-height: 260px;
      overflow: auto;
      padding: 0.3rem;
      margin-bottom: 0.9rem;
      background: rgba(15, 23, 42, 0.7);
    }

    .lista-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.4rem;
      border-bottom: 1px solid rgba(15, 23, 42, 0.8);
      font-size: 0.8rem;
    }

    .lista-item:last-child {
      border-bottom: none;
    }

    .lista-item-info {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .lista-item-title {
      font-weight: 500;
    }

    .lista-item-location {
      color: var(--muted);
      font-size: 0.75rem;
    }

    @media (max-width: 800px) {
      .admin-layout {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border);
        padding-bottom: 0.6rem;
        margin-bottom: 0.6rem;
      }
      .nav-btn {
        display: inline-flex;
        width: auto;
        margin-right: 0.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Administrador de instalaciones</h1>
    <p>Zona privada para gestionar la colecci√≥n <strong>instalaciones</strong>. Es necesario iniciar sesi√≥n.</p>

    <!-- TARJETA DE LOGIN -->
    <div id="loginCard" class="card">
      <div class="card-header-row">
        <div class="card-title">Acceso</div>
      </div>
      <p class="small">
        Usa el usuario y contrase√±a facilitados.
      </p>
      <form id="loginForm">
        <div class="field">
          <div class="field-label">Correo electr√≥nico</div>
          <input id="loginEmail" class="input" type="email" required placeholder="tu_correo@ejemplo.com" />
        </div>
        <div class="field">
          <div class="field-label">Contrase√±a</div>
          <input id="loginPassword" class="input" type="password" required placeholder="********" />
        </div>
        <div class="btn-row">
          <button type="submit" class="btn btn-primary">Iniciar sesi√≥n</button>
        </div>
        <div id="loginStatus" class="status"></div>
      </form>
    </div>

    <!-- TARJETA DE ADMIN (OCULTA SI NO HAY LOGIN) -->
    <div id="adminCard" class="card" style="display:none;">
      <div class="card-header-row">
        <div class="card-title">Panel de administraci√≥n</div>
        <button id="btnLogout" type="button" class="btn btn-ghost">Cerrar sesi√≥n</button>
      </div>
      <p class="small" id="userInfo"></p>

      <div class="admin-layout">
        <!-- MEN√ö LATERAL -->
        <aside class="sidebar">
          <div class="section-title">Modo</div>
          <button id="navNueva" class="nav-btn active" data-mode="nueva">‚ûï Nueva instalaci√≥n</button>
          <button id="navEditar" class="nav-btn" data-mode="editar">‚úèÔ∏è Editar instalaci√≥n</button>
          <button id="navBorrar" class="nav-btn" data-mode="borrar">üóëÔ∏è Borrar instalaci√≥n</button>
        </aside>

        <!-- CONTENIDO PRINCIPAL -->
        <main class="admin-main">
          <!-- LISTA PARA EDITAR / BORRAR -->
          <div id="viewLista" style="display:none;">
            <div class="section-title" id="listaTitulo">Instalaciones</div>
            <div id="listaInstalacionesAdmin" class="lista-admin"></div>
          </div>

          <!-- FORMULARIO NUEVA / EDITAR -->
          <form id="formInstalacion">
            <!-- =====================
                 IDENTIFICACI√ìN B√ÅSICA
                 ===================== -->
            <div class="section-title" id="tituloFormulario">Nueva instalaci√≥n</div>

            <div class="field">
              <div class="field-label">Nombre de la instalaci√≥n *</div>
              <input id="nombre" class="input" type="text" required placeholder="Ej: Albergue Santa Mar√≠a del Valle" />
            </div>

            <div class="row">
              <div class="field">
                <div class="field-label">Comunidad aut√≥noma</div>
                <select id="comunidad" class="select">
                  <option value="">Sin especificar</option>
                  <option value="Andaluc√≠a">Andaluc√≠a</option>
                  <option value="Arag√≥n">Arag√≥n</option>
                  <option value="Asturias">Asturias</option>
                  <option value="Islas Baleares">Islas Baleares</option>
                  <option value="Canarias">Canarias</option>
                  <option value="Cantabria">Cantabria</option>
                  <option value="Castilla-La Mancha">Castilla-La Mancha</option>
                  <option value="Castilla y Le√≥n">Castilla y Le√≥n</option>
                  <option value="Catalu√±a">Catalu√±a</option>
                  <option value="Comunidad Valenciana">Comunidad Valenciana</option>
                  <option value="Extremadura">Extremadura</option>
                  <option value="Galicia">Galicia</option>
                  <option value="Comunidad de Madrid">Comunidad de Madrid</option>
                  <option value="Regi√≥n de Murcia">Regi√≥n de Murcia</option>
                  <option value="Navarra">Navarra</option>
                  <option value="Pa√≠s Vasco">Pa√≠s Vasco</option>
                  <option value="La Rioja">La Rioja</option>
                  <option value="Ceuta">Ceuta</option>
                  <option value="Melilla">Melilla</option>
                </select>
              </div>
              <div class="field">
                <div class="field-label">Provincia</div>
                <input id="provincia" class="input" type="text" placeholder="Ej: Le√≥n" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <div class="field-label">Municipio / pueblo</div>
                <input id="municipio" class="input" type="text" placeholder="Ej: Cistierna" />
              </div>
              <div class="field">
                <div class="field-label">Direcci√≥n (si se conoce)</div>
                <input id="direccion" class="input" type="text" placeholder="Calle, km, parroquia..." />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <div class="field-label">Tipo</div>
                <select id="tipo" class="select">
                  <option value="">Sin especificar</option>
                  <option value="Albergue">Albergue</option>
                  <option value="Campamento">Campamento</option>
                  <option value="Casa rural">Casa rural</option>
                  <option value="Residencia">Residencia</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div class="field">
                <div class="field-label">Entorno</div>
                <select id="entorno" class="select">
                  <option value="">Sin especificar</option>
                  <option value="Monta√±a">Monta√±a</option>
                  <option value="Playa">Playa</option>
                  <option value="Rural">Rural</option>
                  <option value="Urbano">Urbano</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <div class="field-label">Uso principal</div>
                <select id="uso_principal" class="select">
                  <option value="">Sin especificar</option>
                  <option value="Campamento de verano">Campamento de verano</option>
                  <option value="Convivencia fin de semana">Convivencia fin de semana</option>
                  <option value="Retiro / espiritualidad">Retiro / espiritualidad</option>
                  <option value="Formaci√≥n">Formaci√≥n</option>
                  <option value="Multiuso">Multiuso</option>
                </select>
              </div>
              <div class="field">
                <div class="field-label">R√©gimen</div>
                <select id="regimen" class="select">
                  <option value="">Sin especificar</option>
                  <option value="PC">Pensi√≥n completa</option>
                  <option value="MP">Media pensi√≥n</option>
                  <option value="SA">Solo alojamiento</option>
                  <option value="Alquiler √≠ntegro">Alquiler √≠ntegro</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
            </div>

            <!-- CONTACTO -->
            <div class="section-title">Contacto</div>
            <div class="row">
              <div class="field">
                <div class="field-label">Tel√©fono</div>
                <input id="telefono" class="input" type="text" placeholder="Ej: 600 123 456" />
              </div>
              <div class="field">
                <div class="field-label">Email de contacto</div>
                <input id="email_contacto" class="input" type="email" placeholder="Ej: reservas@albergue.com" />
              </div>
            </div>

            <div class="field">
              <div class="field-label">Web oficial (si tiene)</div>
              <input id="web_oficial" class="input" type="url" placeholder="https://..." />
            </div>

            <!-- CAPACIDAD -->
            <div class="section-title">Capacidad y estancias</div>
            <div class="row">
              <div class="field">
                <div class="field-label">Plazas m√≠nimas recomendadas</div>
                <input id="plazas_min" class="input" type="number" min="0" placeholder="Ej: 40" />
              </div>
              <div class="field">
                <div class="field-label">Plazas m√°ximas aproximadas</div>
                <input id="plazas_max" class="input" type="number" min="0" placeholder="Ej: 120" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <div class="field-label">N¬∫ de habitaciones / salas de dormir</div>
                <input id="habitaciones" class="input" type="text" placeholder="Ej: 10 habitaciones de 8" />
              </div>
              <div class="field">
                <div class="field-label">Ba√±os / duchas</div>
                <input id="banos" class="input" type="text" placeholder="Ej: 6 ba√±os y 10 duchas" />
              </div>
            </div>

            <!-- SERVICIOS CERCANOS -->
            <div class="section-title">Servicios cercanos</div>
            <div class="row">
              <div class="field">
                <div class="field-label">Distancia a supermercado</div>
                <input id="distancia_supermercado" class="input" type="text" placeholder="Ej: 5 km en coche" />
              </div>
              <div class="field">
                <div class="field-label">Distancia a centro m√©dico</div>
                <input id="distancia_centro_medico" class="input" type="text" placeholder="Ej: 20 min en coche" />
              </div>
            </div>

            <!-- NORMAS / SEGURIDAD -->
            <div class="section-title">Normas y seguridad</div>
            <div class="field">
              <div class="field-label">Restricciones / normas relevantes</div>
              <textarea id="restricciones" class="textarea" placeholder="Ej: Silencio a partir de las 23:00, no se puede usar piscina por la noche..."></textarea>
            </div>

            <div class="row">
              <div class="field">
                <div class="field-label">Horarios de silencio</div>
                <input id="horarios_silencio" class="input" type="text" placeholder="Ej: 23:00‚Äì8:00" />
              </div>
              <div class="field">
                <div class="field-label">L√≠mite de tama√±o de grupo</div>
                <input id="limite_grupos" class="input" type="text" placeholder="Ej: M√°x. 80 personas por grupo" />
              </div>
            </div>

            <div class="field">
              <div class="field-label">Riesgos cercanos</div>
              <textarea id="riesgos_cercanos" class="textarea" placeholder="R√≠o cercano, carretera, barranco, etc."></textarea>
            </div>

            <!-- CARACTER√çSTICAS -->
            <div class="section-title">Caracter√≠sticas de la instalaci√≥n</div>
            <div class="checkbox-group">
              <label><input id="piscina" type="checkbox" />Piscina</label>
              <label><input id="tiene_campo_deportivo" type="checkbox" />Campo deportivo</label>
              <label><input id="zona_exterior_grande" type="checkbox" />Zona exterior grande</label>
              <label><input id="sombra_exterior" type="checkbox" />Zona con sombra</label>
              <label><input id="cocina_industrial" type="checkbox" />Cocina industrial</label>
              <label><input id="cocina_propia" type="checkbox" />Cocina propia</label>
              <label><input id="sala_multiusos" type="checkbox" />Sala multiusos</label>
              <label><input id="transporte_publico" type="checkbox" />Transporte p√∫blico cercano</label>
              <label><input id="acceso_bus" type="checkbox" />Acceso bus grande</label>
              <label><input id="parking" type="checkbox" />Parking</label>
              <label><input id="accesible" type="checkbox" />Accesible</label>
              <label><input id="alquiler_exclusivo" type="checkbox" />Alquiler exclusivo</label>
              <label><input id="calefaccion" type="checkbox" />Calefacci√≥n</label>
              <label><input id="aire_acondicionado" type="checkbox" />Aire acondicionado</label>
              <label><input id="vallado" type="checkbox" />Recinto vallado</label>
              <label><input id="zona_tiendas_campana" type="checkbox" />Zona para montar tiendas</label>
              <label><input id="espacio_intendencia" type="checkbox" />Espacio intendencia / botiqu√≠n</label>
            </div>

            <!-- NOTAS / VALORACI√ìN -->
            <div class="section-title">Notas internas / valoraci√≥n</div>
            <div class="field">
              <div class="field-label">Notas p√∫blicas (lo que ver√°n los dem√°s)</div>
              <textarea id="notas_publicas" class="textarea" placeholder="Ej: Muy buen trato, perfecto para grupos de 50‚Äì70, recomendable para monitores novatos..."></textarea>
            </div>

            <div class="row">
              <div class="field">
                <div class="field-label">Valoraci√≥n interna (1‚Äì5)</div>
                <input id="valoracion_interna" class="input" type="number" min="0" max="5" step="1" placeholder="Ej: 4" />
              </div>
            </div>

            <div class="section-title">Acciones</div>
            <div class="btn-row">
              <button type="submit" id="btnGuardar" class="btn btn-primary">Guardar instalaci√≥n</button>
              <button type="button" id="btnLimpiar" class="btn btn-secondary">Limpiar formulario</button>
            </div>

            <div id="status" class="status"></div>

            <div class="section-title">Recordatorio</div>
            <div class="tag-list">
              Campos que no se conozcan: d√©jalos vac√≠os, el sistema los tratar√° como ‚ÄúSin informaci√≥n‚Äù.
            </div>
          </form>
        </main>
      </div>
    </div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <script>
    // MISMA CONFIG QUE EN LA WEB P√öBLICA
    const firebaseConfig = {
      apiKey: "AIzaSyD_qFTqRsPwHTO9P8nyfikyWSAV1kt7k90",
      authDomain: "red-albergues.firebaseapp.com",
      projectId: "red-albergues",
      storageBucket: "red-albergues.firebasestorage.app",
      messagingSenderId: "325280024828",
      appId: "1:325280024828:web:1bc121e6089e105d386f79",
      measurementId: "G-JZXCJFMMEB"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // LOGIN / ADMIN DOM
    const loginCard = document.getElementById("loginCard");
    const adminCard = document.getElementById("adminCard");
    const loginForm = document.getElementById("loginForm");
    const loginEmail = document.getElementById("loginEmail");
    const loginPassword = document.getElementById("loginPassword");
    const loginStatus = document.getElementById("loginStatus");
    const userInfo = document.getElementById("userInfo");
    const btnLogout = document.getElementById("btnLogout");

    // Modo admin
    const navNueva = document.getElementById("navNueva");
    const navEditar = document.getElementById("navEditar");
    const navBorrar = document.getElementById("navBorrar");
    const viewLista = document.getElementById("viewLista");
    const listaTitulo = document.getElementById("listaTitulo");
    const listaInstalacionesAdmin = document.getElementById("listaInstalacionesAdmin");
    const tituloFormulario = document.getElementById("tituloFormulario");
    const btnGuardar = document.getElementById("btnGuardar");

    const form = document.getElementById("formInstalacion");
    const statusEl = document.getElementById("status");
    const btnLimpiar = document.getElementById("btnLimpiar");

    let modoActual = "nueva";              // "nueva" | "editar" | "borrar"
    let instalacionesCache = [];           // lista de instalaciones cargadas
    let instalacionEditandoId = null;      // id de doc cuando editamos

    /* ======== AUTENTICACI√ìN ======== */
    auth.onAuthStateChanged((user) => {
      if (user) {
        loginCard.style.display = "none";
        adminCard.style.display = "block";
        userInfo.textContent = "Sesi√≥n iniciada como " + (user.email || "(usuario sin email)");
        cargarListaAdmin();
      } else {
        adminCard.style.display = "none";
        loginCard.style.display = "block";
        userInfo.textContent = "";
      }
    });

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginStatus.textContent = "Iniciando sesi√≥n...";
      loginStatus.classList.remove("error");
      try {
        const email = loginEmail.value.trim();
        const pass = loginPassword.value;
        await auth.signInWithEmailAndPassword(email, pass);
        loginStatus.textContent = "";
      } catch (error) {
        console.error(error);
        loginStatus.textContent = "Error al iniciar sesi√≥n: " + error.message;
        loginStatus.classList.add("error");
      }
    });

    btnLogout.addEventListener("click", () => {
      auth.signOut();
    });

    /* ======== MODO (MEN√ö LATERAL) ======== */
    function activarBotonModo(modo) {
      [navNueva, navEditar, navBorrar].forEach(btn => btn.classList.remove("active"));
      if (modo === "nueva") navNueva.classList.add("active");
      if (modo === "editar") navEditar.classList.add("active");
      if (modo === "borrar") navBorrar.classList.add("active");
    }

    function cambiarModo(modo) {
      modoActual = modo;
      activarBotonModo(modo);

      if (modo === "nueva") {
        viewLista.style.display = "none";
        form.style.display = "block";
        tituloFormulario.textContent = "Nueva instalaci√≥n";
        btnGuardar.textContent = "Guardar instalaci√≥n";
        instalacionEditandoId = null;
        statusEl.textContent = "";
        limpiarFormulario();
      } else if (modo === "editar") {
        viewLista.style.display = "block";
        form.style.display = "block";
        tituloFormulario.textContent = "Editar instalaci√≥n seleccionada";
        btnGuardar.textContent = "Guardar cambios";
        listaTitulo.textContent = "Elige una instalaci√≥n para editar";
        statusEl.textContent = "";
        cargarListaAdmin();
      } else if (modo === "borrar") {
        viewLista.style.display = "block";
        form.style.display = "none";
        listaTitulo.textContent = "Elige una instalaci√≥n para borrar";
        statusEl.textContent = "";
        cargarListaAdmin();
      }
    }

    navNueva.addEventListener("click", () => cambiarModo("nueva"));
    navEditar.addEventListener("click", () => cambiarModo("editar"));
    navBorrar.addEventListener("click", () => cambiarModo("borrar"));

    /* ======== UTILIDADES FORMULARIO ======== */
    function valOrSinInfo(el) {
      const v = el.value.trim();
      return v === "" ? "Sin informaci√≥n" : v;
    }

    function setInputValueOrEmpty(id, value) {
      const el = document.getElementById(id);
      if (!el) return;
      if (!value || value === "Sin informaci√≥n") {
        el.value = "";
      } else {
        el.value = value;
      }
    }

    function limpiarFormulario() {
      form.reset();
      instalacionEditandoId = null;
    }

    btnLimpiar.addEventListener("click", () => {
      limpiarFormulario();
      statusEl.textContent = "";
      if (modoActual === "editar") {
        tituloFormulario.textContent = "Editar instalaci√≥n seleccionada";
      } else {
        tituloFormulario.textContent = "Nueva instalaci√≥n";
      }
    });

    function construirDataDesdeFormulario() {
      const ahora = firebase.firestore.FieldValue.serverTimestamp();

      const base = {
        nombre: document.getElementById("nombre").value.trim() || "Instalaci√≥n sin nombre",
        comunidad: valOrSinInfo(document.getElementById("comunidad")),
        provincia: valOrSinInfo(document.getElementById("provincia")),
        municipio: valOrSinInfo(document.getElementById("municipio")),
        direccion: valOrSinInfo(document.getElementById("direccion")),
        tipo: valOrSinInfo(document.getElementById("tipo")),
        entorno: valOrSinInfo(document.getElementById("entorno")),
        uso_principal: valOrSinInfo(document.getElementById("uso_principal")),
        regimen: valOrSinInfo(document.getElementById("regimen")),

        telefono: valOrSinInfo(document.getElementById("telefono")),
        email_contacto: valOrSinInfo(document.getElementById("email_contacto")),
        web_oficial: valOrSinInfo(document.getElementById("web_oficial")),

        plazas_min: document.getElementById("plazas_min").value ? Number(document.getElementById("plazas_min").value) : null,
        plazas_max: document.getElementById("plazas_max").value ? Number(document.getElementById("plazas_max").value) : null,
        habitaciones: valOrSinInfo(document.getElementById("habitaciones")),
        banos: valOrSinInfo(document.getElementById("banos")),

        distancia_supermercado: valOrSinInfo(document.getElementById("distancia_supermercado")),
        distancia_centro_medico: valOrSinInfo(document.getElementById("distancia_centro_medico")),

        restricciones: valOrSinInfo(document.getElementById("restricciones")),
        horarios_silencio: valOrSinInfo(document.getElementById("horarios_silencio")),
        limite_grupos: valOrSinInfo(document.getElementById("limite_grupos")),
        riesgos_cercanos: valOrSinInfo(document.getElementById("riesgos_cercanos")),

        piscina: document.getElementById("piscina").checked,
        tiene_campo_deportivo: document.getElementById("tiene_campo_deportivo").checked,
        zona_exterior_grande: document.getElementById("zona_exterior_grande").checked,
        sombra_exterior: document.getElementById("sombra_exterior").checked,
        cocina_industrial: document.getElementById("cocina_industrial").checked,
        cocina_propia: document.getElementById("cocina_propia").checked,
        sala_multiusos: document.getElementById("sala_multiusos").checked,
        transporte_publico: document.getElementById("transporte_publico").checked,
        acceso_bus: document.getElementById("acceso_bus").checked,
        parking: document.getElementById("parking").checked,
        accesible: document.getElementById("accesible").checked,
        alquiler_exclusivo: document.getElementById("alquiler_exclusivo").checked,
        calefaccion: document.getElementById("calefaccion").checked,
        aire_acondicionado: document.getElementById("aire_acondicionado").checked,
        vallado: document.getElementById("vallado").checked,

        zona_tiendas_campana: document.getElementById("zona_tiendas_campana").checked,
        espacio_intendencia: document.getElementById("espacio_intendencia").checked,

        notas_publicas: valOrSinInfo(document.getElementById("notas_publicas")),
        valoracion_interna: document.getElementById("valoracion_interna").value
          ? Number(document.getElementById("valoracion_interna").value)
          : null,

        ultima_actualizacion: ahora
      };

      return { base, ahora };
    }

    /* ======== GUARDAR (NUEVA / EDITAR) ======== */
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusEl.textContent = "Guardando...";
      statusEl.classList.remove("error");

      try {
        const { base, ahora } = construirDataDesdeFormulario();

        if (modoActual === "editar" && instalacionEditandoId) {
          // EDITAR: solo actualizamos, sin tocar creado_en
          await db.collection("instalaciones").doc(instalacionEditandoId).update(base);
          statusEl.textContent = "Cambios guardados correctamente.";
        } else {
          // NUEVA: a√±adimos creado_en
          const dataNueva = { ...base, creado_en: ahora };
          await db.collection("instalaciones").add(dataNueva);
          statusEl.textContent = "Instalaci√≥n guardada correctamente.";
          limpiarFormulario();
        }

        cargarListaAdmin();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error al guardar la instalaci√≥n.";
        statusEl.classList.add("error");
      }
    });

    /* ======== CARGAR LISTA PARA EDITAR/BORRAR ======== */
    async function cargarListaAdmin() {
      try {
        const snapshot = await db.collection("instalaciones").orderBy("nombre").get();
        instalacionesCache = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        pintarListaAdmin();
      } catch (err) {
        console.error("Error cargando instalaciones admin:", err);
        listaInstalacionesAdmin.innerHTML = "<div class='small'>Error al cargar instalaciones.</div>";
      }
    }

    function pintarListaAdmin() {
      listaInstalacionesAdmin.innerHTML = "";

      if (!instalacionesCache.length) {
        listaInstalacionesAdmin.innerHTML = "<div class='small'>No hay instalaciones guardadas.</div>";
        return;
      }

      instalacionesCache.forEach(inst => {
        const item = document.createElement("div");
        item.className = "lista-item";

        const comunidad = inst.comunidad && inst.comunidad !== "Sin informaci√≥n" ? inst.comunidad : "";
        const provincia = inst.provincia && inst.provincia !== "Sin informaci√≥n" ? inst.provincia : "";
        const municipio = inst.municipio && inst.municipio !== "Sin informaci√≥n" ? inst.municipio : "";

        item.innerHTML = `
          <div class="lista-item-info">
            <div class="lista-item-title">${inst.nombre || "Instalaci√≥n sin nombre"}</div>
            <div class="lista-item-location">${municipio} ${provincia ? "¬∑ " + provincia : ""} ${comunidad ? "¬∑ " + comunidad : ""}</div>
          </div>
          <div class="lista-item-actions"></div>
        `;

        const actions = item.querySelector(".lista-item-actions");

        if (modoActual === "editar") {
          const btnEdit = document.createElement("button");
          btnEdit.type = "button";
          btnEdit.className = "btn btn-secondary btn-small";
          btnEdit.textContent = "Editar";
          btnEdit.addEventListener("click", () => cargarInstalacionEnFormulario(inst));
          actions.appendChild(btnEdit);
        } else if (modoActual === "borrar") {
          const btnDel = document.createElement("button");
          btnDel.type = "button";
          btnDel.className = "btn btn-secondary btn-small";
          btnDel.textContent = "Borrar";
          btnDel.addEventListener("click", () => borrarInstalacion(inst));
          actions.appendChild(btnDel);
        }

        listaInstalacionesAdmin.appendChild(item);
      });
    }

    function cargarInstalacionEnFormulario(inst) {
      instalacionEditandoId = inst.id;

      setInputValueOrEmpty("nombre", inst.nombre);
      setInputValueOrEmpty("comunidad", inst.comunidad);
      setInputValueOrEmpty("provincia", inst.provincia);
      setInputValueOrEmpty("municipio", inst.municipio);
      setInputValueOrEmpty("direccion", inst.direccion);
      setInputValueOrEmpty("tipo", inst.tipo);
      setInputValueOrEmpty("entorno", inst.entorno);
      setInputValueOrEmpty("uso_principal", inst.uso_principal);
      setInputValueOrEmpty("regimen", inst.regimen);

      setInputValueOrEmpty("telefono", inst.telefono);
      setInputValueOrEmpty("email_contacto", inst.email_contacto);
      setInputValueOrEmpty("web_oficial", inst.web_oficial);

      document.getElementById("plazas_min").value = inst.plazas_min != null ? inst.plazas_min : "";
      document.getElementById("plazas_max").value = inst.plazas_max != null ? inst.plazas_max : "";

      setInputValueOrEmpty("habitaciones", inst.habitaciones);
      setInputValueOrEmpty("banos", inst.banos);
      setInputValueOrEmpty("distancia_supermercado", inst.distancia_supermercado);
      setInputValueOrEmpty("distancia_centro_medico", inst.distancia_centro_medico);

      setInputValueOrEmpty("restricciones", inst.restricciones);
      setInputValueOrEmpty("horarios_silencio", inst.horarios_silencio);
      setInputValueOrEmpty("limite_grupos", inst.limite_grupos);
      setInputValueOrEmpty("riesgos_cercanos", inst.riesgos_cercanos);

      document.getElementById("piscina").checked = !!inst.piscina;
      document.getElementById("tiene_campo_deportivo").checked = !!inst.tiene_campo_deportivo;
      document.getElementById("zona_exterior_grande").checked = !!inst.zona_exterior_grande;
      document.getElementById("sombra_exterior").checked = !!inst.sombra_exterior;
      document.getElementById("cocina_industrial").checked = !!inst.cocina_industrial;
      document.getElementById("cocina_propia").checked = !!inst.cocina_propia;
      document.getElementById("sala_multiusos").checked = !!inst.sala_multiusos;
      document.getElementById("transporte_publico").checked = !!inst.transporte_publico;
      document.getElementById("acceso_bus").checked = !!inst.acceso_bus;
      document.getElementById("parking").checked = !!inst.parking;
      document.getElementById("accesible").checked = !!inst.accesible;
      document.getElementById("alquiler_exclusivo").checked = !!inst.alquiler_exclusivo;
      document.getElementById("calefaccion").checked = !!inst.calefaccion;
      document.getElementById("aire_acondicionado").checked = !!inst.aire_acondicionado;
      document.getElementById("vallado").checked = !!inst.vallado;

      document.getElementById("zona_tiendas_campana").checked = !!inst.zona_tiendas_campana;
      document.getElementById("espacio_intendencia").checked = !!inst.espacio_intendencia;

      document.getElementById("notas_publicas").value = inst.notas_publicas && inst.notas_publicas !== "Sin informaci√≥n"
        ? inst.notas_publicas
        : "";
      document.getElementById("valoracion_interna").value = inst.valoracion_interna != null ? inst.valoracion_interna : "";

      tituloFormulario.textContent = "Editando: " + (inst.nombre || "Instalaci√≥n sin nombre");
      statusEl.textContent = "Editando instalaci√≥n. Al guardar se actualizar√° este registro.";
      statusEl.classList.remove("error");

      // Aseguramos que estamos en modo editar
      if (modoActual !== "editar") {
        cambiarModo("editar");
      }

      // Peque√±o scroll al formulario
      form.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    async function borrarInstalacion(inst) {
      const nombre = inst.nombre || "esta instalaci√≥n";
      const ok = confirm(`¬øSeguro que quieres borrar "${nombre}"? Esta acci√≥n no se puede deshacer.`);
      if (!ok) return;

      try {
        await db.collection("instalaciones").doc(inst.id).delete();
        if (instalacionEditandoId === inst.id) {
          limpiarFormulario();
          instalacionEditandoId = null;
        }
        cargarListaAdmin();
        statusEl.textContent = `Instalaci√≥n "${nombre}" borrada correctamente.`;
        statusEl.classList.remove("error");
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error al borrar la instalaci√≥n.";
        statusEl.classList.add("error");
      }
    }

    // Modo inicial
    cambiarModo("nueva");
  </script>
</body>
</html>
